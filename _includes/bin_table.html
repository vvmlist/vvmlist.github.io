<div id="bin-search-wrapper">
 	<ul id="bin-search-filters-dif" class="diffi-list">
        {% for diffi_pair in site.data.diffis %}
        {% assign diffi_id = diffi_pair[0] %}
        {% assign diffi = diffi_pair[1] %}
        <li><a href="#+{{ diffi.label | downcase }}">{{ diffi.label }}</a></li>
        {% endfor %}
    </ul>
	<ul id="bin-search-filters-pla" class="platf-list">
        {% for platf_pair in site.data.platfs %}
        {% assign platf_id = platf_pair[0] %}
        {% assign platf = platf_pair[1] %}
        <li><a href="#+{{ platf.label | downcase }}">{{ platf.label }}</a></li>
        {% endfor %}
    </ul>
    <ul id="bin-search-filters" class="function-list">
        {% for function_pair in site.data.functions %}
        {% assign function_id = function_pair[0] %}
        {% assign function = function_pair[1] %}
        <li><a href="#+{{ function.label | downcase }}" data-title="{{ function.description | replace: '\n', ' ' }}">{{ function.label }}</a></li>
        {% endfor %}
    </ul>

    <input id="bin-search" type="text" placeholder="search among {{ site.vvmlist | size }} vms or <vm> +<tag> ..."/>
<!--     <input id="bin-search" type="text" placeholder="search vms..."/> -->
</div>

<div id="bin-table-wrapper">
    <table id="bin-table">
        <thead>
            <tr>
                <th>name</th>
				<th>difficulty</th>
				<th>platform</th>
                <th>tags</th>
				<th>url</th>
				<th>walkthrough</th>
            </tr>
        </thead>
        <tbody>
            {% for file in site.vvmlist %}
            <tr>
                <td class="vvm-name"><a class="bin-name">{% include get_bin_name path=file.path %}</a></td>
				<td class="vvm-diffi">{% include diffi_list.html bin=file %}</td>
				<td class="vvm-platf">{% include platf_list.html bin=file %}</td>
                <td>{% include function_list.html bin=file %}</td>
				<td class="vvm-curl">{% include curl_list.html bin=file %}</td>
				<td class="vvm-wal">{% include wal_list.html bin=file %}</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr><td id="search-message" colspan="2">no matches...</td></tr>
        </tfoot>
    </table>
</div>

<script>
function filter(query) {
    var queryArray = query.toLowerCase().trim().split(/ *\+/);
    var binPattern = queryArray[0];
    var functionPatterns = queryArray.splice(1);

    // check for quoted exact match
    var isQuoted = binPattern.startsWith('"') && binPattern.endsWith('"');
    if (isQuoted) {
        binPattern = binPattern.slice(1, -1); // remove the quotes
    }

    var noResults = true;
    document.querySelectorAll('#bin-table tbody tr').forEach(function (row) {
        var show = true;

        var binName = row.children[0].firstElementChild.innerText.toLowerCase().trim();

        if (isQuoted) {
            // exact match if quoted
            if (binName !== binPattern) {
                show = false;
            }
        } else {
            // partial match if not quoted
            if (!binName.includes(binPattern)) {
                show = false;
            }
        }

        if (show) {
            var functionElems = Array.from(row.children[3].firstElementChild.children);
            functionElems.forEach((item) => {
                item.className = '';
            });
            functionPatterns.forEach((pattern) => {
                if (!pattern) return;
                var noMatches = true;
                functionElems.forEach((item) => {
                    if (item.innerText.toLowerCase().startsWith(pattern.toLowerCase())) {
                        item.className = 'match';
                        noMatches = false;
                    }
                });
                if (noMatches) {
                    show = false;
                }
            });
        }

        row.style.display = show ? '' : 'none';
        if (show) noResults = false;
    });

    var searchMessage = document.getElementById('search-message');
    searchMessage.style.display = noResults ? 'table-cell' : 'none';
}


 function applyFilter() {
     // filter on load according to the URL
     var searchBox = document.getElementById('bin-search');
     var query = decodeURIComponent(location.hash.slice(1));
     filter(query);
     if (query) {
         searchBox.value = query;
     }
 }

 function setup() {
     var searchBox = document.getElementById('bin-search');

     // ensure height during filtering
     var binTableWrapper = document.getElementById('bin-table-wrapper');
     binTableWrapper.style.height = binTableWrapper.clientHeight + 'px';

     // handle user input
     searchBox.addEventListener('input', function () {
         var query = searchBox.value;
         history.replaceState(null, null, encodeURI('#' + query));
         applyFilter();
     });

     // handle shortcuts
     addEventListener('keydown', function (event) {
         // focus search box on valid keydown
         if (event.key.toLowerCase().match(/^[+a-z]$/) &&
             !(event.ctrlKey || event.altKey || event.metaKey)) {
             searchBox.focus();
             searchBox.parentElement.scrollIntoView();
         }
         // clear filter on escape
         else if (event.key === 'Escape') {
             location.hash = searchBox.value = '';
             searchBox.focus();
             searchBox.parentElement.scrollIntoView();
         }
     });

     // handle URL changes
     window.onhashchange = applyFilter;

     // trigger filter on page load
     applyFilter();
 }

 setup();
</script>
